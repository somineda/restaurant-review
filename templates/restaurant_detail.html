<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ì‹ë‹¹ ìƒì„¸</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { padding: 2rem; }
    .review-card { margin-bottom: 1.5rem; }
  </style>
</head>
<body>
  <div class="container">

    <!-- âœ… ë©”ì¸ìœ¼ë¡œ ëŒì•„ê°€ê¸° ë²„íŠ¼ -->
    <div class="mb-4">
      <a href="/" class="btn btn-outline-primary">â† ë©”ì¸ìœ¼ë¡œ</a>
    </div>

    <!-- ì‹ë‹¹ ì •ë³´ -->
    <div id="restaurant-info" class="card mb-4 p-4 shadow-sm"></div>

    <!-- ë¦¬ë·° ëª©ë¡ -->
    <h3>ğŸ“ ë¦¬ë·° ëª©ë¡</h3>
    <div id="review-list" class="mb-5"></div>

    <!-- ë¦¬ë·° ì‘ì„± -->
    <div class="card p-4 shadow-sm">
      <h4>âœï¸ ë¦¬ë·° ì‘ì„±</h4>
      <form id="review-form">
        <div class="mb-3">
          <textarea name="comment" class="form-control" placeholder="ë¦¬ë·° ë‚´ìš©" rows="4" required></textarea>
        </div>
        <button type="submit" class="btn btn-primary">ë¦¬ë·° ë“±ë¡</button>
      </form>
    </div>
  </div>

  <script>
    const pathParts = window.location.pathname.split('/');
    const restaurantId = pathParts[2];
    const token = localStorage.getItem('access');

    // ì‹ë‹¹ ì •ë³´ ë¶ˆëŸ¬ì˜¤ê¸°
    fetch(`http://localhost:8000/restaurants/${restaurantId}/`)
      .then(res => res.json())
      .then(data => {
        document.getElementById('restaurant-info').innerHTML = `
          <h2 class="card-title">${data.name}</h2>
          ${data.image ? `<img src="${data.image}" class="img-fluid my-3 rounded">` : ''}
          <p class="mb-1"><strong>ì„¤ëª…:</strong> ${data.description || ''}</p>
          <p class="mb-1"><strong>ì£¼ì†Œ:</strong> ${data.address}</p>
          <p class="mb-1"><strong>ì—°ë½ì²˜:</strong> ${data.contact || '-'}</p>
          <p class="mb-1"><strong>ì˜ì—…ì‹œê°„:</strong> ${data.open_time || '-'} ~ ${data.close_time || '-'}</p>
          <p><strong>ì •ê¸°íœ´ë¬´:</strong> ${data.regular_holiday || '-'}</p>
        `;
      });

    // ë¦¬ë·° ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
    fetch(`http://localhost:8000/restaurants/${restaurantId}/reviews/`, {
      headers: {
        'Authorization': 'Bearer ' + token
      }
    })
      .then(res => {
        if (!res.ok) throw new Error("ë¦¬ë·° ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨");
        return res.json();
      })
      .then(data => {
        const container = document.getElementById('review-list');
        const reviews = data.results || data;
        reviews.forEach(review => {
          const div = document.createElement('div');
          div.className = 'card p-3 review-card shadow-sm';
          div.innerHTML = `
            <p>${review.comment}</p>
            <small class="text-muted">ì‘ì„±ì: ${review.user?.nickname || review.user?.email || 'ìµëª…'} | ${review.created_at?.slice(0, 10) || ''}</small>
          `;
          container.appendChild(div);
        });
      })
      .catch(err => console.error(err));

    // ë¦¬ë·° ì‘ì„±
    document.getElementById('review-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const form = e.target;
      const payload = {
        comment: form.comment.value
      };

      const res = await fetch(`http://localhost:8000/restaurants/${restaurantId}/reviews/`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + token
        },
        body: JSON.stringify(payload)
      });

      if (res.status === 201) {
        alert('âœ… ë¦¬ë·° ë“±ë¡ ì™„ë£Œ');
        location.reload();
      } else {
        const errText = await res.text();
        alert('âŒ ë¦¬ë·° ë“±ë¡ ì‹¤íŒ¨: ' + errText);
      }
    });
  </script>
</body>
</html>
