<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ì‹ë‹¹ ìƒì„¸</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { padding: 2rem; }
    .review-card { margin-bottom: 1.5rem; }
  </style>
</head>
<body>
  <div class="container">
    <!-- ì‹ë‹¹ ì •ë³´ -->
    <div id="restaurant-info" class="card mb-4 p-4 shadow-sm">
      <!-- JavaScriptë¡œ ì±„ì›Œì§ -->
    </div>

    <!-- ë¦¬ë·° ëª©ë¡ -->
    <h3>ğŸ“ ë¦¬ë·° ëª©ë¡</h3>
    <div id="review-list" class="mb-5">
      <!-- JavaScriptë¡œ ì±„ì›Œì§ -->
    </div>

    <!-- ë¦¬ë·° ì‘ì„± -->
    <div class="card p-4 shadow-sm">
      <h4>âœï¸ ë¦¬ë·° ì‘ì„±</h4>
      <form id="review-form">
        <div class="mb-3">
          <input type="text" name="title" class="form-control" placeholder="ì œëª©" required>
        </div>
        <div class="mb-3">
          <textarea name="comment" class="form-control" placeholder="ë¦¬ë·° ë‚´ìš©" rows="4" required></textarea>
        </div>
        <button type="submit" class="btn btn-primary">ë¦¬ë·° ë“±ë¡</button>
      </form>
    </div>
  </div>

  <script>
    // URLì—ì„œ /restaurants/2/detail/ ì—ì„œ 2ë§Œ ì¶”ì¶œ
    const pathParts = window.location.pathname.split('/');
    const restaurantId = pathParts[2];

    // ì‹ë‹¹ ì •ë³´ ë¶ˆëŸ¬ì˜¤ê¸°
    fetch(`http://localhost:8000/restaurants/${restaurantId}/`)
      .then(res => res.json())
      .then(data => {
        document.getElementById('restaurant-info').innerHTML = `
          <h2 class="card-title">${data.name}</h2>
          ${data.image ? `<img src="${data.image}" class="img-fluid my-3 rounded">` : ''}
          <p class="mb-1"><strong>ì„¤ëª…:</strong> ${data.description || ''}</p>
          <p class="mb-1"><strong>ì£¼ì†Œ:</strong> ${data.address}</p>
          <p class="mb-1"><strong>ì—°ë½ì²˜:</strong> ${data.contact || '-'}</p>
          <p class="mb-1"><strong>ì˜ì—…ì‹œê°„:</strong> ${data.open_time || '-'} ~ ${data.close_time || '-'}</p>
          <p><strong>ì •ê¸°íœ´ë¬´:</strong> ${data.regular_holiday || '-'}</p>
        `;
      });

    // ë¦¬ë·° ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
    fetch(`http://localhost:8000/reviews/?restaurant=${restaurantId}`)
      .then(res => res.json())
      .then(data => {
        const container = document.getElementById('review-list');
        data.results.forEach(review => {
          const div = document.createElement('div');
          div.className = 'card p-3 review-card shadow-sm';
          div.innerHTML = `
            <h5>${review.title}</h5>
            <p>${review.comment}</p>
            <small class="text-muted">ì‘ì„±ì: ${review.user?.email || 'ìµëª…'} | ${review.created_at?.slice(0, 10)}</small>
          `;
          container.appendChild(div);
        });
      });

    // ë¦¬ë·° ì‘ì„±
    document.getElementById('review-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const form = e.target;
      const payload = {
        restaurant: restaurantId,
        title: form.title.value,
        comment: form.comment.value
      };

      const res = await fetch('http://localhost:8000/reviews/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify(payload)
      });

      if (res.status === 201) {
        alert('âœ… ë¦¬ë·° ë“±ë¡ ì™„ë£Œ');
        location.reload();
      } else {
        alert('âŒ ë¦¬ë·° ë“±ë¡ ì‹¤íŒ¨');
      }
    });

    // CSRF helper
    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let cookie of cookies) {
          const trimmed = cookie.trim();
          if (trimmed.startsWith(name + '=')) {
            cookieValue = decodeURIComponent(trimmed.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }
  </script>
</body>
</html>
